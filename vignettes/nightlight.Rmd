---
title: "nightlight"
author: "Pilar Delpino Marimon"
date: "7/21/2022"
vignette: >
  %\VignetteIndexEntry{nightlight}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

# install libraries

```{r}
install.packages(c("here", "geojsonsf", "sp", "sf", "terra", "raster",
                   "exactextractr", "dplyr", "tidyr", "zoo", "rgdal", "classInt",
                   "ggplot2", "RColorBrewer", "viridis", "kableExtra"))

```

# Load Libraries

```{r include=FALSE}
#library(USFlite)
library(here)
library(geojsonsf) 
library(sp)
library(sf)
library(terra) 
library(raster)
library(exactextractr) 
library(dplyr)
library(tidyr)
library(zoo)
library(rgdal)
library(classInt)
library(ggplot2)
library(RColorBrewer) # Use for color palettes
library(viridis) # Use for color palettes
library(kableExtra) # Use for data table formatting
```

# Load shapefiles - Proj: New York State Plane Long Island Zone (EPSG 2263)

```{r include=FALSE}
# NYC census tracts
nytract <- readRDS(here("nightlight/nytract.RDS")) 

# NYC public housing developments
nycha <- readRDS(here("nightlight/nycha.RDS")) 

# Polo Grounds Towers to test hypothesis - capture floodlight presence
polo <- readRDS(here("nightlight/polo.RDS"))

# Import population data
ny_pop <- readRDS(here("nightlight/ny_pop.RDS")) 

# Download geojson of NYC building footprints
# download.file("https://www.dropbox.com/s/o1griqqa1biezpc/buildings.geojson?dl=1",
#                           destfile = "~/USFlite/nightlight/buildings.geojson")

# Read buildings geojson
#buildings <- geojson_sf("~/USFlite/nightlight/buildings.geojson") 
buildings <- geojson_sf("~/Clark/RA-ing/SummerInstitute/nightlight/data/buildings.geojson")

# BLM protests at night
blm_pts_night <- readRDS(here("nightlight/blm_pts_night.RDS"))
```

### Display tracts with public housing in blue, and Polo Grounds in red with circle hightlighting the area

```{r echo=FALSE}
ggplot() +
  geom_sf(data = nytract, col = alpha("grey9", 0.1), fill = "grey") +
  geom_sf(data = nycha, aes(fill = 'A'), col = "blue4", 
          show.legend = "polygon", inherit.aes = F) +
  geom_sf(data = polo, aes(fill = 'B'), col = NA,
          show.legend = "polygon", inherit.aes = F) +
  geom_sf(data = polo %>% st_geometry() %>% st_centroid() %>% st_buffer(2000), 
          fill = NA, col = 'red4', 
          show.legend = F, inherit.aes = F) +
  ggtitle("NYC Public Housing Developments") +
  scale_fill_manual(values = c("A" = "blue", "B" = "red"), 
                    labels = c("Public Housing Developments", 
                               "Polo Grounds Towers")) +
  xlab('') + ylab('') +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.title = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        legend.position = c(0.22, 0.92)) 
```

## Masked visualization of the mean NYC nighttime lights from 2012 to 2022.

```{r}
# load raster stack
s <- stack(here("nightlight/s.tif"))
# load names
n <- readRDS(here("nightlight/n.RDS")) 
# assign names to stack
names(s) <- n
plot(s)

# calculate mean radiance
mean_s <- calc(s, mean, na.rm = TRUE)
plot(mean_s)

# Convert raster to dataframe for plotting
mean_s_df <- as.data.frame(rasterToPoints(mean_s))
colnames(mean_s_df) <- c('x', 'y', 'value')
```

### Plot long term mean of nighttime lights for NYC

```{r}
ggplot() + 
  geom_raster(aes(x = x, y = y, fill = value), data = mean_s_df) +
  ggtitle("NYC Nighttime Lights mean radiance 2012 - 2022") +
  scale_fill_viridis(guide = guide_colorbar(title = "nWatts·cm−2·sr−1", 
                                             ticks = FALSE)) +
  xlab('') + ylab('') +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        legend.position = c(0.2, 0.8)) 
```

#  Testing hypthesis: detect light installation on Polo Grounds Towers

```{r}
#Names of each layer aka dates in format Xyyyyjjj
 names_s <- names(s)

# taking out the X in the dates
dates_yj <- as.data.frame(names_s) %>%  lapply(., function(x) {
  gsub("X", "", x)})

#converting from yyyyjjj to date data format
dates <- lapply(dates_yj, function(x) {
  as.Date(x, format = "%Y%j")
})

#adding dates as z value to each layer
p <- as.data.frame(dates)
s2 <- setZ(s, p[,1], "date")
dates <- getZ(s2)
class(getZ(s2)) 
print(s2)
```

```{r}
#Query Formatting
instal_sub <- subset(s2, which(getZ(s2) >= '2015-7-01' & 
                                 (getZ(s2) <= '2016-03-10')))
plot(instal_sub)

#Getting subsets of before and after year of known installation 
before_inst_sub <- subset(s2, which(getZ(s2) <= '2015-07-01' & 
                                  (getZ(s2) >= '2014-07-01')))
plot(before_inst_sub)

after_inst_sub <- subset(s2, which(getZ(s2) >= '2016-03-10' & 
                                 (getZ(s2) <= '2017-03-10')))
plot(after_inst_sub)

#Creating one year means before and after the installation of lights at Polo Grounds

before_mean <- calc(before_inst_sub, mean, na.rm = TRUE)
plot(before_mean)

after_mean <- calc(after_inst_sub, mean, na.rm = TRUE)
plot(after_mean)


#Plots of before and after means 
ba_mean_s <- stack(before_mean, after_mean)
names(ba_mean_s) <- c("Aug_2014-2015", "Aug_2016-2017")
plot(ba_mean_s)

#Anomalies of radinace, from before and after light installation
diff <- (after_mean - before_mean)
plot(diff)

#Histogram of the difference, where positive values indicate increase in values and negative indicates decrease in values
par(mar = c(3, 3, 3, 3))
hist(diff, col = "blue", xlab = "iradiance", breaks = 12)

#cropping the anamoly for Polo Grounds, turns out only 1 pixel
rpolo_ann <- crop(x = diff, y = st_transform(polo, st_crs(diff)))
plot(rpolo_ann)
plot(st_transform(polo, st_crs(diff))$geometry, add = T)
```


### Subsetting on a ~3 year time frame of before during and after light installation to see if one can find anomalies 

```{r}
# reproject polo to WGS 84, EPSG:4326 
polo <- polo %>% st_transform(., crs = 4326)

sub1 <- subset(s2, which(getZ(s2) >= '2014-07-01' & (getZ(s2) <= '2017-06-30')))
plot(sub1)

polo_s <- crop(x = sub1, y = st_transform(polo, st_crs(sub1)))

st_bbox(polo_s)
st_bbox(polo)
plot(polo_s[[5]])
plot(polo$geometry, add = TRUE)

polo_frame <- raster::extract(
  x = polo_s, 
  y = st_transform(polo, st_crs(polo_s)), small = TRUE, 
  na.rm = TRUE) %>% unlist(.) %>% as.data.frame(.) #%>% 
 # mutate(., date = getZ(sub1)) # this line doesn't work

bb <- st_bbox(st_transform(polo, st_crs(polo_s)))
plot(polo_s[[5]], xlim = bb[c(1, 3)], ylim = bb[c(2, 4)])
bb
st_transform(polo, st_crs(polo_s))


polo_roll <- polo_frame %>% mutate(month_av = rollapply(polo[[1]], 
              width = 30, FUN = function(x) mean(x, na.rm = TRUE), fill = NA))
```

### Creation of 30 day rolling mean of 3 year chunk analyzed above to display why a decrease in radiance is seen

```{r}
polo_roll %>% 
ggplot() + 
  geom_line(mapping = aes(x = date, y = month_av), size = 1.2, col = "blue") +
  geom_line(polo_roll[(361:614),], mapping = aes(x = date, y = month_av), 
            size = 1.2, col = "red") +
  xlab("Date") + ylab("Radiancen (Watts·cm^−2·sr^−1)") +
  ggtitle("Polo Grounds 30 day rolling mean with light installation period highlighted in red") 
```

### Seeing Polo Grounds in the context of the whole time series by doing a 30 day rolling mean.


```{r}

# Cropping the time series to Polo Grounds
polo_s2 <- crop(x = s2, y = polo) # error no non-missing arguments to min
# Making a data frame from those radiance values form all the layers
polo_frame_full_full <- raster::extract(x = polo_s2,
                   y = polo, exact = TRUE, na.rm = TRUE) %>% unlist(.) %>% 
                  as.data.frame(.) %>% mutate(., date = getZ(s2))
# Executing a rolling mean of 30 days across the whole time series and saving it as a new column in the data frame.
polo_roll_full <- polo_frame_full_full %>%
  mutate(month_av = rollapply(polo_frame_full_full[[1]],
                width = 30, FUN = function(x) mean(x, na.rm = TRUE), fill = NA))
# NA values are excluded from this rolling mean and the first 15 are NA.
```

```{r}
polo_roll_full %>% 
ggplot() + geom_line(mapping = aes(x = date, y = month_av), col = "blue", size = 1.2) +
  geom_line(polo_roll_full[(1244:1497), ], 
            mapping = aes(x = date, y = month_av), col = "red", size = 1.2) +
  ggtitle("Rolling 30 day mean over Polo Grounds with light installation period highlighted in red") +
  ylab("Radaice (Watts·cm^−2·sr^−1)") + xlab(NULL) 
```

### Looking at quarterly means to smooth over short term trends.

```{r}
# Summarizing the radiance values over Polo Grounds by 3-month means in an effort
# to lessen the influence of the February spike in radiance seen every year. 
zoo_frame <- polo_roll_full %>% 
  mutate(quarter = as.yearqtr(polo_roll_full$date, format = "%Y-%m-%d")) %>%
  mutate(radiance = as.numeric(polo_roll_full$.)) %>% 
  group_by(quarter) %>% 
  summarise(., mean = mean(radiance, na.rm = TRUE)) %>% 
  as.data.frame(.) %>% 
  mutate(year = as.yearqtr(.$quarter, format = "%y/0%q") %>%
  format(., format = "%y")) %>%
  mutate(row_num = seq.int(nrow(.))) %>% 
  mutate(group = ifelse(row_num < 15, "Before", 
                        ifelse(row_num > 17, "After", "During")))
# Looking at the difference of before and after installation with full time scale
zoo_table <- zoo_frame %>% 
  group_by(group) %>% 
  summarise(., mean = round(mean(mean))) %>% 
  as.data.frame(.) 
# Adding the difference row in the table
zoo_table[nrow(zoo_table) + 1, ] <- c("difference", 
                                      (zoo_table$mean[1] - zoo_table$mean[2]))
# Creation of a more visually appealing table
zoo_table %>% kable() %>% kable_styling()

```

### Line plot of quarterly 

```{r}
ggplot(zoo_frame) +
  geom_line(aes(x = quarter, y = mean), size = 0.5) + ylab("Radiance") +
  geom_point(mapping = aes(x = quarter, y = mean, color = group), size = 2) +
  xlab(NULL) +
  ggtitle("Comparison of radiance of before and after
light instalation at Polo Grounds by looking at quarterly means") 
```

# BLM Protest Analysis

### Visualize Night protest points
```{r}
par(mar = c(0, 0, 1, 0))
plot(nytract %>% st_geometry(), col = "grey", pch = NA, border = "grey9", 
     main = "BLM Protest Locations")
plot(blm_pts_night %>% st_geometry(), col = "blue", pch = 16, add = TRUE)
```


## Plotting long term mean of Nighttime lights with BLM Protest Points on top. 

```{r, error = TRUE, warning = FALSE, message = FALSE, fig.height = 6, eval = FALSE}
ggplot() + 
  geom_raster(aes(x = x, y = y, fill = value), data = mean_s_df) +
  geom_sf(data = nytract, fill = NA, col = alpha("white", 0.2)) +
  geom_sf(data = blm_pts_night_night, fill = NA, col = "deeppink") + 
  ggtitle("Mean Radiance 2012 - 2022 with BLM Protest Points") +
  scale_fill_gradient(low = 'black', high = 'yellow',
                      guide = guide_colorbar(title = "", 
                                             ticks = FALSE)) +
  xlab('') + ylab('') +
  coord_sf(expand = 0) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks = element_blank()) 
```

### Polo Ground Code / BLM Protest Point Work Space

Using NASA black marble to evaluate mean nighttime lights and dates. 

Figuring out means for BLM Protest Areas using Polo Ground and NASA Black Marble data.

```{r}
#Getting subsets of before and after year of known installation 
blm_2020_sub <- subset(s2, which(getZ(s2) >= '2020-5-28' & 
                                   (getZ(s2) <= '2020-06-01')))
blm_2019_sub <- subset(s2, which(getZ(s2) >= '2019-5-28' & 
                                   (getZ(s2) <= '2019-06-01')))
blm_2018_sub <- subset(s2, which(getZ(s2) >= '2018-5-28' & 
                                   (getZ(s2) <= '2018-06-01')))
blm_2017_sub <- subset(s2, which(getZ(s2) >= '2017-5-28' & 
                                   (getZ(s2) <= '2017-06-01')))

#Creating one year means before and after the installation of lights at Polo Grounds
blm_2020_mean <- mean(blm_2020_sub, na.rm = TRUE)
blm_2019_mean <- mean(blm_2019_sub, na.rm = TRUE)
blm_2018_mean <- mean(blm_2018_sub, na.rm = TRUE)
blm_2017_mean <- mean(blm_2017_sub, na.rm = TRUE)

#Plots of before and after means 
blm_mean_s <- stack(blm_2020_mean, blm_2019_mean, blm_2019_mean, blm_2017_mean)
names(blm_mean_s) <- c("May_June_2020", "May_June_2019", 
                       "May_June_2018", "May_June_2017")
blm_mean_overtime <- plot(blm_mean_s)

```

# Public Housing Lights Analysis


```{r}
# Define raster with extent and resolution as mean nighttime lights
r <- mean_s
values(r) <- 1:ncell(r)

# Create raster with proportion of pixel covered by public housing
city_background <- pop_r
city_background[city_background >= 0] <- 0

ph_fraction <- coverage_fraction(r, st_combine(nycha))[[1]]
ph_fraction[is.na(ph_fraction)] <- 0

ph_fraction <- mask(ph_fraction, city_background)

ph_frac_df <- as.data.frame(rasterToPoints(ph_fraction))
colnames(ph_frac_df) <- c('x', 'y', 'value')
ph_frac_df <- ph_frac_df %>% filter(!is.na(value)) 
```

